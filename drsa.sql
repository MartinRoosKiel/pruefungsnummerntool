SELECT pr.Vorname, pr.Name,(case when wh.datum > ks.ende then wh.Datum else ks.ende end) as Datum, pr.Nummer FROM pruefung pr left join wiederholung wh on pr.Name = wh.Nachname and pr.Vorname = wh.Vorname join kurse ks on pr.Kurs = ks.id where pr.Vorname = 'Martin' and pr.Name = 'Roos' and Datum = (Select max(Datum) from ((Select ks.Ende as Datum from pruefung pr join kurse ks on pr.kurs = ks.id where pr.Vorname LIKE 'Martin' and pr.Name LIKE 'Roos') Union (Select wh.Datum from wiederholung wh where wh.Vorname LIKE 'Martin' and wh.Nachname LIKE 'Roos' )) as date) and Datum > (SELECT Date(DATE_SUB(now(), INTERVAL 6 Year)))
